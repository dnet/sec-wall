{% extends "base/_layout.html" %}

{% hyde
    section_title: Documentation
    has_exercises: "True"
    has_this_page: "True"
%}

{% block section_title %}Logging{% endblock %}

{% block exercises %}
    <li>123
    </li>
{% endblock %}

{% block this_page %}
    <li><a href="#intro">Introduction</a></li>
    <li><a href="#http-headers">HTTP headers</a>
        <ol>
            <li><a href="#http-headers-default">Default configuration</a></li>
            <li><a href="#http-headers-configure">Configuring HTTP headers</a></li>
            <li><a href="#http-headers-format">The headers format</a></li>
        </ol>
    </li>
    <li><a href="#log-entries">Log entries</a>
        <ol>
            <li><a href="#log-entries-default">Default configuration</a></li>
            <li><a href="#log-entries-configure">Configuring log entries</a></li>
            <li><a href="#log-entries-format">The log entry format</a></li>
        </ol>
    </li>
    <li><a href="#exercises">Exercises</a></li>
{% endblock %}

{% block content %}

{% markdown %}

<h1>Logging</h1>

<h2 id="intro">Introduction</h2>

There are several layers of logging employed by sec-wall. Proper understanding
of all of them is essential for mastering sec-wall yet not all of them will come
in handy in day-to-day work - some of them are rarely needed, for instance, only
when you're to deal with misbehaving proxy instances, others - like the log of
requests passing through a proxy - will be used more frequently.

What gets logged where and why stems directly from
[how sec-wall has been designed](/documentation/arch/index.html)
and the sketch diagram below captures the flow of information that controls the logging process.
Note that all paths are relative to
[the config.py file](/documentation/ref-docs/config-file.html).

<div style="text-align:center">
  <img src="/media/gfx/logging.png" alt=""/>
</div>

You'll remember that
[sec-wall runs under a control of zdaemon](/documentation/arch/index.html), that's
why when the proxy is starting or stopping, there's a log entry being written
to the ./zdaemon.log file, basically the information which process is that of sec-wall
and that it has just started or stopped.

An unhandled error while processing an incoming client requests is always wrapped
in an HTTP 500 error and any information that might aid with resolving
the issue is being written to the ./logs/proxy.log file.

If config.py says that
[add_invocation_id](/documentation/ref-docs/config-file.html#add_invocation_id)
and
[sign_invocation_id](/documentation/ref-docs/config-file.html#sign_invocation_id)
are in effect, the necessary HTTP headers are created. Their format is documented
in [a separate section](#http-headers).

The regular log entries - showing what applications were accessing sec-wall, when it was,
whether they succeeded or not and [similar things](#log-entries) - are being written to
[syslog by default](#configuring-the-logger)
and their format
is documented
in
[a separate section](#log-entries).
Whether they're written at all though depends on
[the log level configured](/documentation/ref-docs/config-file.html#log_level).
They're emitted on either INFO or ERROR level so if you change the log level to,
say, CRITICAL, you'll never have any regular log messages written to the logs.

<h2 id="http-headers">HTTP headers</h2>
<h4 id="http-headers-default">Default configuration</h4>
The default configuration is governed by the config.py-wide variables:
<a href="/documentation/ref-docs/config-file.html#add_invocation_id">add_invocation_id</a>
and
<a href="/documentation/ref-docs/config-file.html#sign_invocation_id">sign_invocation_id</a>.
<br/>
<br/>

<h4 id="http-headers-configure">Configuring HTTP headers</h4>

Visit the sections about
<a href="/documentation/ref-docs/config-file.html#add_invocation_id">add_invocation_id</a>
and
<a href="/documentation/ref-docs/config-file.html#sign_invocation_id">sign_invocation_id</a>
variables for information on how to influence when the invocation ID-related headers
are being added.
<br/>
<br/>

<h4 id="http-headers-format">The headers format</h4>

An invocation ID is a string that uniquely identifies the given exchange of data
between a client application and a sec-wall instance. As long as
<a href="/documentation/ref-docs/config-file.html#INSTANCE_UNIQUE">the INSTANCE_UNIQUE variable</a>
actually stays unique, the ID will be unique.
<br/><br/>

The exact formula for creating the <b>X-sec-wall-invocation-id</b> HTTP header is:
<br/><br/>

separator = '/'
<br/>
msg_number = msg_counter.next()
<br/>
invocation_id = <a href="/documentation/ref-docs/config-file.html#instance_name">instance_name</a>
    + separator + <a href="/documentation/ref-docs/config-file.html#INSTANCE_UNIQUE">INSTANCE_UNIQUE</a> + separator + msg_number

<br/><br/>

where <i>msg_counter</i> is an
<a href="http://docs.python.org/library/itertools.html#itertools.count">itertools.count</a>
<img src="/media/gfx/external-link.png" alt="" /> instance, starting with 1,
recycled on each sec-wall's restart.

<br/><br/>

<h2 id="log-entries">Log entries</h2>

Each client's accessing a sec-wall instance ends in a log entry being emitted
to the logs. The log entries constitute both an access and an error log in the
sense that they're being written regardless of the HTTP response code, be it
2xx, 4xx, 5xx or any other.

<h4 id="log-entries-default">Default configuration</h4>

By default, if you haven't changed anything yet, sec-wall will be using local
syslog. The messages will be written to
<a href="/documentation/ref-docs/config-file.html#syslog_address">/dev/syslog</a>
using the
<a href="/documentation/ref-docs/config-file.html#syslog_facility">LOG_USER</a>
facility. Each message will be on either INFO or ERROR level which means that
all of the messages will land in syslog because the default
log level is
<a href="/documentation/ref-docs/config-file.html#log_level">INFO</a>.

<h4 id="log-entries-configure">Configuring log entries</h4>

Changing the configuration may mean modifying the information about where syslog
is to be found, changing the log level or making sec-wall stop using syslog at all
in favour of any of
[the logging facilities Python supports](http://docs.python.org/library/logging.html) ![](/media/gfx/external-link.png)
.

<h4 id="log-entries-format">The log entry format</h4>

<h2 id="examples">Examples</h2>

There's [a whole chapter devoted to nothing but showing various examples of sec-wall's configuration files](/ZZZ),
head over there for more information.

{% endmarkdown %}

{% endblock %}
